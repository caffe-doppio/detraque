#!/bin/bash

# detraque - Outil de nettoyage d'URLs avec tracking commercial
# Casse le tracking âŒğŸª
#
# Copyright (C) 2025 @caffe-doppio
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
# Supporte : YouTube, X/Twitter, Facebook, Instagram
# GitHub : https://github.com/caffe-doppio/detraque

VERSION="0.1.0"
LOG_DIR="$HOME/Documents/detraque-logs"
LOG_FILE="$LOG_DIR/$(date +%Y-%m-%d)-cleaned-urls.md"

# Couleurs pour l'output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# CrÃ©er le dossier de logs s'il n'existe pas
mkdir -p "$LOG_DIR"

# Fonction d'aide
show_help() {
    echo -e "${GREEN}"
    echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—"
    echo "â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•"
    echo "â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  "
    echo "â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–„â–„ â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  "
    echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—"
    echo "â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â–€â–€â•â•  â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•"
    echo "                                                                    "
    echo -e "${NC}"
    
    echo -e "${BLUE}detraque${NC} v${VERSION} - Casse le tracking âŒğŸª"
    echo -e "Ton URL sans tracking commercial en deux clicks"
    echo ""
    echo -e "${YELLOW}USAGE:${NC}"
    echo -e "    detraque ${GREEN}clean${NC} <url>                  Nettoyer une URL"
    echo -e "    detraque ${GREEN}clean-time${NC} <url> <hh:mm:ss>  Nettoyer + ajouter timestamp"
    echo -e "    detraque ${GREEN}timestamp${NC} <hh:mm:ss> [url]   Convertir timestamp + gÃ©nÃ©rer lien"
    echo -e "    detraque ${GREEN}verify${NC} <url>                 VÃ©rifier si l'URL est fonctionnelle"
    echo -e "    detraque ${GREEN}logs${NC}                         Afficher les logs du jour"
    echo ""
    echo -e "${YELLOW}EXEMPLES:${NC}"
    echo -e "    detraque ${GREEN}clean${NC} \"https://www.youtube.com/watch?v=abc123&si=tracker\""
    echo -e "    detraque ${GREEN}clean-time${NC} \"https://youtube.com/watch?v=abc&si=x\" 1:08:33"
    echo -e "    detraque ${GREEN}timestamp${NC} 1:23:45"
    echo -e "    detraque ${GREEN}timestamp${NC} 1:23:45 \"https://youtube.com/watch?v=abc123\""
    echo -e "    detraque ${GREEN}verify${NC} \"https://youtube.com/watch?v=abc123\""
    echo -e "    detraque ${GREEN}logs${NC}"
    echo ""
    echo -e "${YELLOW}PLATEFORMES SUPPORTÃ‰ES:${NC}"
    echo "    â€¢ YouTube     : Retire ?si=, &feature=, &utm_*"
    echo "    â€¢ X/Twitter   : Retire ?s=, ?t=, &utm_*"
    echo "    â€¢ Facebook    : Retire ?fbclid=, &utm_*"
    echo "    â€¢ Instagram   : Retire ?igshid=, &utm_*"
    echo ""
    echo -e "${YELLOW}LOGS:${NC}"
    echo "    Les URLs nettoyÃ©es sont automatiquement loggÃ©es dans :"
    echo "    ${LOG_DIR}/YYYY-MM-DD-cleaned-urls.md"
    echo ""
    echo -e "${YELLOW}CHEATSHEET:${NC}"
    echo -e "    detraque ${GREEN}help${NC}                         Afficher cette aide"
    echo ""
}

# Fonction de logging
log_clean() {
    local original="$1"
    local cleaned="$2"
    local timestamp_str="$3"  # timestamp optionnel (format hh:mm:ss)
    local log_timestamp=$(date "+%Y-%m-%d %H:%M:%S")
    
    # CrÃ©er l'en-tÃªte si le fichier n'existe pas
    if [[ ! -f "$LOG_FILE" ]]; then
        cat > "$LOG_FILE" << EOF
# URLs nettoyÃ©es - $(date +%Y-%m-%d)

---

EOF
    fi
    
    # Ajouter l'entrÃ©e avec ou sans timestamp
    if [[ -n "$timestamp_str" ]]; then
        cat >> "$LOG_FILE" << EOF
## [$log_timestamp] - Timestamp: $timestamp_str

**Original :**
\`\`\`
$original
\`\`\`

**NettoyÃ© :**
\`\`\`
$cleaned
\`\`\`

---

EOF
    else
        cat >> "$LOG_FILE" << EOF
## [$log_timestamp]

**Original :**
\`\`\`
$original
\`\`\`

**NettoyÃ© :**
\`\`\`
$cleaned
\`\`\`

---

EOF
    fi
}

# Fonction d'affichage des logs du jour
show_logs() {
    if [[ ! -f "$LOG_FILE" ]]; then
        echo -e "${YELLOW}âš  Aucun log pour aujourd'hui${NC}"
        echo -e "${BLUE}Fichier attendu :${NC} $LOG_FILE"
        exit 0
    fi
    
    echo -e "${BLUE}Logs du jour :${NC} $(date +%Y-%m-%d)"
    echo -e "${BLUE}Fichier :${NC} $LOG_FILE"
    echo ""
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    cat "$LOG_FILE"
    
    echo ""
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    # Compter le nombre d'URLs nettoyÃ©es
    local count=$(grep -c "^## \[" "$LOG_FILE" 2>/dev/null || echo "0")
    echo -e "${GREEN}âœ“ ${count} URL(s) nettoyÃ©e(s) aujourd'hui${NC}"
}

# Fonction clean + timestamp combinÃ©s
clean_time() {
    local url="$1"
    local time="$2"
    
    if [[ -z "$url" ]]; then
        echo -e "${RED}Erreur : URL manquante${NC}"
        echo "Usage : detraque clean-time <url> <hh:mm:ss>"
        exit 1
    fi
    
    if [[ -z "$time" ]]; then
        echo -e "${RED}Erreur : Timestamp manquant${NC}"
        echo "Usage : detraque clean-time <url> <hh:mm:ss>"
        exit 1
    fi
    
    # Retirer les backslashes d'Ã©chappement du shell
    url=$(echo "$url" | sed 's/\\//g')
    
    # DÃ©tection de la plateforme
    local platform="Inconnue"
    if [[ "$url" =~ youtube\.com|youtu\.be ]]; then
        platform="YouTube"
    elif [[ "$url" =~ twitter\.com|x\.com ]]; then
        platform="X/Twitter"
    elif [[ "$url" =~ facebook\.com|fb\.com ]]; then
        platform="Facebook"
    elif [[ "$url" =~ instagram\.com ]]; then
        platform="Instagram"
    fi
    
    # Nettoyage des paramÃ¨tres de tracking
    local cleaned="$url"
    
    # ParamÃ¨tres YouTube
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)si=[^&]*(&|$)/\1/')
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)feature=[^&]*(&|$)/\1/')
    
    # ParamÃ¨tres X/Twitter
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)s=[^&]*(&|$)/\1/')
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)t=[^&]*(&|$)/\1/')
    
    # ParamÃ¨tres Facebook
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)fbclid=[^&]*(&|$)/\1/')
    
    # ParamÃ¨tres Instagram
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)igshid=[^&]*(&|$)/\1/')
    
    # ParamÃ¨tres UTM universels
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)utm_[^&]*(&|$)/\1/g')
    
    # Nettoyer les & ou ? orphelins Ã  la fin
    cleaned=$(echo "$cleaned" | sed -E 's/[?&]$//')
    cleaned=$(echo "$cleaned" | sed -E 's/&+/\&/g')
    
    # Calculer le timestamp en secondes
    local hours=0
    local minutes=0
    local seconds=0
    
    IFS=':' read -ra PARTS <<< "$time"
    
    case ${#PARTS[@]} in
        1)
            seconds=${PARTS[0]}
            ;;
        2)
            minutes=${PARTS[0]}
            seconds=${PARTS[1]}
            ;;
        3)
            hours=${PARTS[0]}
            minutes=${PARTS[1]}
            seconds=${PARTS[2]}
            ;;
        *)
            echo -e "${RED}Erreur : Format timestamp invalide${NC}"
            echo "Formats acceptÃ©s : hh:mm:ss, mm:ss, ou ss"
            exit 1
            ;;
    esac
    
    local total=$((10#$hours * 3600 + 10#$minutes * 60 + 10#$seconds))
    
    # Ajouter le timestamp Ã  l'URL nettoyÃ©e
    if [[ "$cleaned" =~ \? ]]; then
        cleaned="${cleaned}&t=${total}s"
    else
        cleaned="${cleaned}?t=${total}s"
    fi
    
    # Affichage
    echo -e "${BLUE}Plateforme dÃ©tectÃ©e :${NC} $platform"
    echo -e "${BLUE}Timestamp :${NC} $time (${total}s)"
    echo ""
    echo -e "${YELLOW}Original :${NC}"
    echo "$url"
    echo ""
    echo -e "${GREEN}NettoyÃ© + Timestamp :${NC}"
    echo "$cleaned"
    
    # Logging avec timestamp
    log_clean "$url" "$cleaned" "$time"
    echo ""
    echo -e "${BLUE}âœ“ LoggÃ© dans :${NC} $LOG_FILE"
    
    # Copier dans le presse-papier si pbcopy disponible (macOS)
    if command -v pbcopy &> /dev/null; then
        echo -n "$cleaned" | pbcopy
        echo -e "${GREEN}âœ“ CopiÃ© dans le presse-papier${NC}"
    fi
}

# Fonction de nettoyage d'URL
clean_url() {
    local url="$1"
    
    if [[ -z "$url" ]]; then
        echo -e "${RED}Erreur : URL manquante${NC}"
        echo "Usage : detraque clean <url>"
        exit 1
    fi
    
    # Retirer les backslashes d'Ã©chappement du shell
    url=$(echo "$url" | sed 's/\\//g')
    
    # DÃ©tection de la plateforme
    local platform="Inconnue"
    if [[ "$url" =~ youtube\.com|youtu\.be ]]; then
        platform="YouTube"
    elif [[ "$url" =~ twitter\.com|x\.com ]]; then
        platform="X/Twitter"
    elif [[ "$url" =~ facebook\.com|fb\.com ]]; then
        platform="Facebook"
    elif [[ "$url" =~ instagram\.com ]]; then
        platform="Instagram"
    fi
    
    # Nettoyage des paramÃ¨tres de tracking
    local cleaned="$url"
    
    # ParamÃ¨tres YouTube
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)si=[^&]*(&|$)/\1/')
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)feature=[^&]*(&|$)/\1/')
    
    # ParamÃ¨tres X/Twitter
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)s=[^&]*(&|$)/\1/')
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)t=[^&]*(&|$)/\1/')
    
    # ParamÃ¨tres Facebook
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)fbclid=[^&]*(&|$)/\1/')
    
    # ParamÃ¨tres Instagram
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)igshid=[^&]*(&|$)/\1/')
    
    # ParamÃ¨tres UTM universels
    cleaned=$(echo "$cleaned" | sed -E 's/(\?|&)utm_[^&]*(&|$)/\1/g')
    
    # Nettoyer les & ou ? orphelins Ã  la fin
    cleaned=$(echo "$cleaned" | sed -E 's/[?&]$//')
    cleaned=$(echo "$cleaned" | sed -E 's/&+/\&/g')
    
    # Affichage
    echo -e "${BLUE}Plateforme dÃ©tectÃ©e :${NC} $platform"
    echo ""
    echo -e "${YELLOW}Original :${NC}"
    echo "$url"
    echo ""
    echo -e "${GREEN}NettoyÃ© :${NC}"
    echo "$cleaned"
    
    # Logging
    log_clean "$url" "$cleaned"
    echo ""
    echo -e "${BLUE}âœ“ LoggÃ© dans :${NC} $LOG_FILE"
    
    # Copier dans le presse-papier si pbcopy disponible (macOS)
    if command -v pbcopy &> /dev/null; then
        echo -n "$cleaned" | pbcopy
        echo -e "${GREEN}âœ“ CopiÃ© dans le presse-papier${NC}"
    fi
}

# Fonction de conversion timestamp
convert_timestamp() {
    local time="$1"
    local url="$2"  # URL optionnelle
    
    if [[ -z "$time" ]]; then
        echo -e "${RED}Erreur : Timestamp manquant${NC}"
        echo "Usage : detraque timestamp <hh:mm:ss> [url]"
        exit 1
    fi
    
    # Supporter plusieurs formats : hh:mm:ss, mm:ss, ss
    local hours=0
    local minutes=0
    local seconds=0
    
    IFS=':' read -ra PARTS <<< "$time"
    
    case ${#PARTS[@]} in
        1)
            seconds=${PARTS[0]}
            ;;
        2)
            minutes=${PARTS[0]}
            seconds=${PARTS[1]}
            ;;
        3)
            hours=${PARTS[0]}
            minutes=${PARTS[1]}
            seconds=${PARTS[2]}
            ;;
        *)
            echo -e "${RED}Erreur : Format invalide${NC}"
            echo "Formats acceptÃ©s : hh:mm:ss, mm:ss, ou ss"
            exit 1
            ;;
    esac
    
    # Calculer le total en secondes (forcer base 10 pour Ã©viter erreur octal)
    local total=$((10#$hours * 3600 + 10#$minutes * 60 + 10#$seconds))
    
    echo -e "${BLUE}Timestamp :${NC} $time"
    echo -e "${GREEN}Secondes :${NC} $total"
    echo ""
    
    # Si une URL est fournie, gÃ©nÃ©rer le lien complet
    if [[ -n "$url" ]]; then
        # Retirer les backslashes d'Ã©chappement du shell
        url=$(echo "$url" | sed 's/\\//g')
        
        local full_link
        
        # DÃ©tecter si l'URL a dÃ©jÃ  des paramÃ¨tres
        if [[ "$url" =~ \? ]]; then
            full_link="${url}&t=${total}s"
        else
            full_link="${url}?t=${total}s"
        fi
        
        echo -e "${GREEN}Lien complet :${NC}"
        echo "$full_link"
        echo ""
        
        # Logger avec timestamp
        log_clean "$url" "$full_link" "$time"
        echo -e "${BLUE}âœ“ LoggÃ© dans :${NC} $LOG_FILE"
        echo ""
        
        # Copier le lien complet dans le presse-papier
        if command -v pbcopy &> /dev/null; then
            echo -n "$full_link" | pbcopy
            echo -e "${GREEN}âœ“ Lien complet copiÃ© dans le presse-papier${NC}"
        fi
    else
        # Sinon, afficher juste le paramÃ¨tre
        echo -e "${YELLOW}Pour YouTube :${NC} Ajouter ${GREEN}&t=${total}s${NC} Ã  l'URL"
        
        # Copier le paramÃ¨tre dans le presse-papier
        if command -v pbcopy &> /dev/null; then
            echo -n "&t=${total}s" | pbcopy
            echo -e "${GREEN}âœ“ ParamÃ¨tre copiÃ© dans le presse-papier${NC}"
        fi
    fi
}

# Fonction de vÃ©rification d'URL
verify_url() {
    local url="$1"
    
    if [[ -z "$url" ]]; then
        echo -e "${RED}Erreur : URL manquante${NC}"
        echo "Usage : detraque verify <url>"
        exit 1
    fi
    
    # Retirer les backslashes d'Ã©chappement du shell
    url=$(echo "$url" | sed 's/\\//g')
    
    echo -e "${BLUE}VÃ©rification de :${NC} $url"
    echo ""
    
    # Effectuer la requÃªte avec User-Agent pour Ã©viter les blocages
    local response=$(curl -s -o /dev/null -w "%{http_code}" -A "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36" "$url")
    
    case $response in
        200)
            echo -e "${GREEN}âœ“ URL fonctionnelle${NC} (HTTP $response)"
            
            # Essayer d'extraire le titre de la page
            local title=$(curl -s -A "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36" "$url" | grep -o '<title>[^<]*' | sed 's/<title>//' | head -1)
            
            if [[ -n "$title" ]]; then
                echo -e "${BLUE}Titre :${NC} $title"
            fi
            ;;
        404)
            echo -e "${RED}âœ— URL introuvable${NC} (HTTP $response)"
            echo -e "${YELLOW}La page n'existe pas ou a Ã©tÃ© supprimÃ©e${NC}"
            ;;
        403)
            echo -e "${YELLOW}âš  AccÃ¨s refusÃ©${NC} (HTTP $response)"
            echo -e "${YELLOW}La page existe mais nÃ©cessite une authentification${NC}"
            ;;
        410)
            echo -e "${RED}âœ— Contenu supprimÃ©${NC} (HTTP $response)"
            ;;
        private|unavailable)
            echo -e "${YELLOW}âš  VidÃ©o privÃ©e ou indisponible${NC}"
            echo -e "${BLUE}Info :${NC} Tu peux peut-Ãªtre y accÃ©der avec tes identifiants"
            ;;
        *)
            echo -e "${YELLOW}âš  Statut HTTP :${NC} $response"
            echo -e "${BLUE}Info :${NC} L'URL pourrait fonctionner dans un navigateur"
            ;;
    esac
}

# Gestion des arguments en mode debug
DEBUG=false
if [[ "$1" == "--debug" ]]; then
    DEBUG=true
    shift
    set -x
fi

# Route principale
case "$1" in
    clean)
        clean_url "$2"
        ;;
    clean-time)
        clean_time "$2" "$3"
        ;;
    timestamp)
        convert_timestamp "$2" "$3"
        ;;
    verify)
        verify_url "$2"
        ;;
    logs)
        show_logs
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        show_help
        ;;
    *)
        echo -e "${RED}Erreur : Commande inconnue '$1'${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
